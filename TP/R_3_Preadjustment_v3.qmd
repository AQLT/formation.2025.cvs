---
title: "3 - Qualité du préajustement sous R"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = FALSE, warning = FALSE,
                      message = FALSE)
options(enable_print_style = FALSE)
library(kableExtra)
library(knitr)
```


> L'objectif de ce TP est d'apprendre à vérifier la qualité du pré-ajustement.


Pour installer tous les packages utiles de ce TP, lancer le programme :

```{r}
#| eval: false
#| label: install
packages_to_install <- c("rjd3toolkit", "rjd3x13", "rjd3tramoseats", "rjd3providers", "rjd3workspace")

packages <- packages_to_install[! packages_to_install %in% installed.packages()[,"Package"]]
if (length(packages) > 0) {
		install.packages(
	  packages, repos = c("https://aqlt.r-universe.dev", "https://cloud.r-project.org")
	  )
}
```



Prenons une spécification par défaut :

```{r}
library(rjd3toolkit)
library(rjd3x13)
ipi_fr <- RJDemetra::ipi_c_eu[, "FR"]
mysa <- rjd3x13::x13(ipi_fr,spec = "RSA5c")
```

Comme on l'a vu dans le TP2, les tests de Student peuvent être utilisés pour tester la significativité des coefficients, et on peut également faire des tests de Fisher avec le package `car` pour voir si l'on peut simplifier les régresseurs jours ouvrables.
Voir également le TP2 pour les tests sur la présence de jours ouvrables résiduelle.

```{r}
summary(mysa$result$preprocessing)
library(car)
# On rejette l'hypothèse de nullité globale des coefficients
linearHypothesis(mysa,
                 c("monday","tuesday","wednesday","thursday","friday","saturday"),
                 c(0, 0, 0, 0, 0, 0), test = "F")
# On pourrait rassembler les jours de la semaine :
linearHypothesis(mysa,
                 c("monday = tuesday","tuesday = wednesday","
                   wednesday = thursday", "thursday = friday"), test = "F")
```

Concernant la qualité du modèle RegARIMA, on peut citer trois tests :

-   Le test d'indépendance des résidus

-   Le test d'homoscédasticité des résidus

-   Le test de normalité des résidus

Ces trois tests, également disponibles par des fonctions spécifiques sous R (la commande `residuals(mysa)` permet de récupérer les résidus du modèle), sont également disponibles dans le sous objet `.$result$preprocessing$diagnostics` :

```{r}
mysa$result$preprocessing$diagnostics
```

L'hétéroscédasticité et la non-normalité proviennent souvent de la présence de points atypiques non corrigés (pour jouer sur le seuil de détection, prendre une valeur de `critical.value` inférieur à 4, qui est la valeur par défaut, dans la fonction `set_outliers`).
Changer le schéma de décomposition peut aussi aider (`transform.function = "None"` pour un modèle additif ou `transform.function = "Log"` pour un modèle multiplicatif) :

```{r}
mysa2 <- rjd3x13::x13(
  ipi_fr, 
  rjd3x13::spec_x13("RSA5c") |> 
    set_outlier(critical.value = 3)
  )
# Bien plus d'outliers sont détectés !
summary(mysa2$result$preprocessing)
```

La qualité des prévisions peut également être vérifiée à travers plusieurs tests :

-   Est-ce que la moyenne des erreurs prévisions *in sample* (i.e. : modèle estimé sur toute la période) et la moyenne des prévisions *out of sample* (i.e. : modèle estimé de manière dynamique en ajoutant une a à une les nouvelles données) sont nulles ?
    Ces tests sont sensibles à la non-normalité des résidus

-   Est-ce que les variances des erreurs de prévision *in sample* et *out of sample* sont les mêmes ?
    Ce test est sensible à la non-normalité des résidus

-   Est-ce qu'il y a "trop" d'outliers ?
    Dans JDemetra+, on considère par défaut qu'il y a trop d'outliers si la proportion d'outliers par rapport aux nombres d'observations est supérieure à 5 %.

Les trois premiers tests ne sont pas par défaut exportés : il faut les rajouter à la main avec le paramètre `userdefined`.
Ils seront alors disponibles dans la sous-liste `.$user_defined`.
Concernant la proportion d'outliers, elle peut être calculée à la main à partir du nombre d'outliers (par exemple disponible dans `.$result_spec$regarima$regression$outliers`) :

```{r}
mysa <- x13(
  ipi_fr, 
  mysa$estimation_spec,
  userdefined = c("diagnostics.fcast-insample-mean",
                  "diagnostics.fcast-outsample-mean",
                  "diagnostics.fcast-outsample-variance")
)

# Pour éviter outputs trop longs, l'affichage est réduit :
mysa$user_defined

# Pour supprimer cela, vous pouvez par exemple utiliser le code suivant :
c(mysa$user_defined)
```

Vous pouvez bien sûr utiliser votre tests préféré à partir de ceux disponibles sous R (autre test de normalité...).

Pour comparer différents modèles, vous pouvez également utiliser les critères d'information (mais il faut que les modèles ARIMA aient les mêmes ordres de différenciation !).
Vous pouvez pour cela utiliser les fonctions de bases de R (`AIC()`, `BIC()`...) ou prendre ceux de JDemetra+ (affichés lors du `summary()`, qu'on peut également retrouver par la commande `.$result$preprocessing$estimation$likelihood`) :

```{r}
AIC(mysa)
BIC(mysa)

# Il y a un peu plus de critères que dans base R :
mysa$result$preprocessing$estimation$likelihood
```

::: callout-note
## Exercice
Prenez une série et étudier la qualité du modèle RegARIMA. 
Essayer de changer quelques paramètres : est-ce que le nouveau modèle vous parait meilleur ou moins bien que l'ancien ?
:::

